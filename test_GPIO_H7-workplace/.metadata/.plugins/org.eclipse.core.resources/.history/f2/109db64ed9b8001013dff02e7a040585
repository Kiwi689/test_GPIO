/*
 * cf_uart_rx.c
 *
 *  Created on: Nov 4, 2025
 *      Author: 35832
 */


#include "usart.h"
#include "stm32h7xx_ll_usart.h"
#include "main.h"
#include "gpio.h"
#include <stdint.h>

/* ç®€å•æ¥æ”¶ï¼šè½®è¯¢ RXNEï¼Œæ”¶ä¸€è¡Œæˆ–è¶…æ—¶ */
static int Uart2_ReadLine(uint8_t *buf, int maxlen, uint32_t timeout_ms)
{
    uint32_t start = HAL_GetTick();
    int n = 0;
    while ((HAL_GetTick() - start) < timeout_ms) {
        if (LL_USART_IsActiveFlag_RXNE(USART2)) {
            uint8_t b = LL_USART_ReceiveData8(USART2);
            if (n < maxlen) buf[n++] = b;
            if (b == '\n') break;   // æ”¶åˆ°æ¢è¡Œå°±è®¤ä¸ºä¸€æ¡æ¶ˆæ¯ç»“æŸ
        }
    }
    return n; // è¿”å›æœ¬æ¬¡è¯»å–å­—èŠ‚æ•°ï¼ˆå¯èƒ½ä¸º 0 è¡¨ç¤ºè¶…æ—¶ï¼‰
}

volatile uint32_t g_recv_count = 0;

void CrazyUART_RecvOnly(void)
{
    uint8_t line[128];

    // å‡†å¤‡ä¸€ä¸ª LED æŒ‡ç¤ºï¼ˆæŒ‰ä½ æ¿å­æ”¹å¼•è„š/å‡½æ•°ï¼‰
    MX_GPIO_Init();  // ç¡®ä¿å·²åˆå§‹åŒ– GPIO
    // å‡è®¾ä½ æœ‰ LED å¼•è„šï¼Œæ¯”å¦‚ LD1ï¼šæ›¿æ¢ä¸ºä½ å·¥ç¨‹é‡Œçš„ ledSet æˆ– HAL_GPIO_TogglePin()
    while (1)
    {
        int n = Uart2_ReadLine(line, sizeof(line), 1500); // 1.5s è¶…æ—¶
        if (n > 0) {
            g_recv_count++;                    // æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯
            HAL_GPIO_TogglePin(GPIOB, GPIO_PIN_0); // ğŸ’¡ æ›¿æ¢æˆä½ çš„ LED å¼•è„š
            // ä¸å›å‘ã€ä¸æ‰“å°ï¼Œåªç”¨ LED/å˜é‡éªŒè¯
        }
        // å°é—´éš”ï¼Œé¿å…ç©ºè½¬å æ»¡ CPU
        HAL_Delay(10);
    }
}
